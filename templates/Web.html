<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generate Digital Signature QR</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen py-10 px-4">

    <div class="w-full max-w-screen-sm mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-md space-y-6">
        <h2 class="text-2xl font-semibold text-center text-blue-700">Generate Digital Signature QR (RSA)</h2>

        <div class="space-y-4">
            <div>
                <label for="content" class="block font-medium mb-1">Pesan:</label>
                <textarea id="content" rows="3" placeholder="Tulis pesan di sini..."
                          class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 resize-none"></textarea>
            </div>

            <div>
                <label for="canvas" class="block font-medium mb-1">Gambar tanda tangan:</label>
                <canvas id="canvas" width="500" height="150"
                        class="w-full max-w-full border border-gray-400 rounded bg-white select-none resize-none"
                        style="resize: none; user-select: none;"></canvas>
                <button onclick="clearCanvas()"
                        class="mt-2 px-4 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">
                    Bersihkan Gambar
                </button>
            </div>

            <button onclick="generateSignature()"
                    class="w-full bg-blue-500 text-white font-semibold py-2 rounded hover:bg-blue-600 transition">
                Generate Signature & QR
            </button>

           
            <div id="warning" class="hidden p-3 rounded border border-red-400 bg-red-100 text-red-700 text-sm text-center shadow">
                Pesan peringatan akan tampil di sini.
            </div>
        </div>

        <div id="result" class="hidden mt-4 p-4 bg-green-100 text-green-800 rounded shadow-inner"></div>

        <div class="text-center mt-6">
            <a href="/" class="inline-block px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                Kembali ke Dashboard
            </a>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        let drawing = false;

        // Mouse events
        canvas.addEventListener("mousedown", () => drawing = true);
        canvas.addEventListener("mouseup", () => { drawing = false; ctx.beginPath(); });
        canvas.addEventListener("mousemove", draw);

        // Touch events (HP / tablet)
        canvas.addEventListener("touchstart", (e) => {
            drawing = true;
            drawTouch(e);
        });
        canvas.addEventListener("touchmove", (e) => {
            drawTouch(e);
        });
        canvas.addEventListener("touchend", () => {
            drawing = false;
            ctx.beginPath();
        });

        function draw(e) {
            if (!drawing) return;
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#000";
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function drawTouch(e) {
            if (!drawing) return;
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#000";
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);

            e.preventDefault(); // mencegah scroll saat menggambar
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
        }

        function isCanvasBlank(canvas) {
            const blank = document.createElement("canvas");
            blank.width = canvas.width;
            blank.height = canvas.height;
            return canvas.toDataURL() === blank.toDataURL();
        }

        function generateSignature() {
            const content = document.getElementById("content").value.trim();
            const canvasData = canvas.toDataURL("image/png");

            if (!content) {
                alert("Silakan isi pesan terlebih dahulu.");
                return;
            }

            if (isCanvasBlank(canvas)) {
                alert("Silakan gambar tanda tangan Anda terlebih dahulu.");
                return;
            }

            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/sign_and_generate_qr";

            const fields = {
                content: content,
                algorithm: "rsa",
                signature_image: canvasData
            };

            for (const [name, value] of Object.entries(fields)) {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = name;
                input.value = value;
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
        }
    </script>

</body>
</html>
